# 实现任务拆分清单（不编码）

> 说明：本文仅给出“实现任务拆分清单”，不包含任何代码。
> 默认值与策略：模板优先、两轮全量尝试、频道黑屏阈值≥20s、
> 失败默认重启流程、允许 OCR 点击关键词。

## 1. 目标与范围

- 目标：基于现有项目逻辑补齐异常处理与场景识别机制。
- 范围：流程设计、模块职责、配置扩展、测试计划拆分。
- 非范围：本清单不进行代码实现与配置落地。

## 2. 任务拆分总览

1. 配置项扩展与校验
2. OCR 结构化输出与关键词定位
3. UI 点击能力补强
4. 场景注册表与模板异常流程
5. OCR 异常流程与通用异常流程
6. 频道专属异常流程
7. 黑屏期保护与模板优先策略落地
8. 通用报错策略与证据留存统一化
9. 日志与可追溯性增强
10. 测试与验收用例设计

## 3. 任务明细

### 3.1 配置项扩展与校验

- 目标：新增异常处理相关配置并进行校验。
- 范围：`config.yaml` 与 `src/config.py`。
- 关键新增字段（默认值）：
  - `flow.exception_keywords`
  - `flow.clickable_keywords`
  - `flow.ocr_keyword_min_score=0.5`
  - `flow.template_exception_rounds=2`
  - `flow.template_fallback_delay_seconds=10`
  - `flow.channel_exception_delay_seconds=20`
  - `flow.error_policy=restart`
- 依赖：无。
- 验收标准：
  - 配置可被成功加载并完成校验。

### 3.2 OCR 结构化输出与关键词定位

- 目标：支持 OCR 返回文本、置信度与坐标。
- 范围：`src/ocr_ops.py`。
- 设计要点：
  - 返回结构包含文本、概率与文本框坐标。
  - 提供“异常关键词检测”与“可点击关键词定位”能力。
- 依赖：OCR 库可用与窗口截图能力。
- 验收标准：
  - 能获取文本框坐标并定位目标关键词。

### 3.3 UI 点击能力补强

- 目标：按 OCR 文本框中心安全点击。
- 范围：`src/ui_ops.py`。
- 设计要点：
  - 点击前进行边界校验与可见性校验。
  - 点击失败可回退到当前点击逻辑。
- 依赖：OCR 结构化结果。
- 验收标准：
  - 能基于 OCR 坐标触发点击。

### 3.4 场景注册表与模板异常流程

- 目标：场景识别可按顺序前后扫描，支持两轮全量尝试。
- 范围：`src/runner.py`。
- 设计要点：
  - 维护场景顺序列表。
  - 期望场景为“频道选择”时跳过向前扫描。
  - 每轮包含向后扫描与向前扫描。
- 依赖：模板匹配能力稳定。
- 验收标准：
  - 能识别到“实际场景名称”并返回跳转。

### 3.5 OCR 异常流程与通用异常流程

- 目标：模板失败后降级 OCR，最终统一报错处理。
- 范围：`src/runner.py` + `src/ocr_ops.py`。
- 设计要点：
  - 动作顺序：Esc → Enter → 点击关键词。
  - 每步后立刻模板识别当前场景。
- 依赖：OCR 结构化结果与点击能力。
- 验收标准：
  - OCR 命中时能恢复到可识别场景。

### 3.6 频道专属异常流程

- 目标：识别“失败提示”并处理刷新逻辑。
- 范围：`src/runner.py`。
- 设计要点：
  - OCR 命中失败关键词后点击“确认/OK”。
  - 触发“刷新频道”并重试识别。
  - 超阈值失败进入通用报错处理。
- 依赖：OCR 异常流程。
- 验收标准：
  - 失败弹窗不再阻塞频道识别。

### 3.7 黑屏期保护与模板优先策略

- 目标：在等待频道界面时保障 20s 黑屏期。
- 范围：`src/runner.py`。
- 设计要点：
  - 20s 内禁止进入异常流程。
  - 模板优先，超阈值才允许 OCR 降级。
- 依赖：模板异常流程。
- 验收标准：
  - 黑屏期内不触发异常处理。

### 3.8 通用报错策略与证据留存统一化

- 目标：任何失败均留证，默认重启流程。
- 范围：新增 `src/evidence.py` 与 `src/runner.py`。
- 设计要点：
  - 统一证据入口：截图、OCR 文本、阶段信息。
  - `error_policy=restart` 为默认路径。
- 依赖：窗口截图与日志能力。
- 验收标准：
  - 失败事件均有可追溯证据。

### 3.9 日志与可追溯性增强

- 目标：异常流程决策可追踪。
- 范围：`src/runner.py`。
- 设计要点：
  - 记录模板轮次、命中场景、阈值分数。
  - 记录 OCR 命中词与点击坐标。
- 依赖：日志系统已存在。
- 验收标准：
  - 日志可复盘异常处理路径。

### 3.10 测试与验收用例设计

- 目标：覆盖关键流程与异常路径。
- 范围：`tests/`（仅设计，暂不实现）。
- 建议用例：
  - 模板异常流程两轮尝试逻辑。
  - OCR 命中异常词后动作序列。
  - 频道专属异常流程与刷新上限。
  - 黑屏期保护（≥20s）策略。
- 验收标准：
  - 设计用例满足核心路径覆盖。

## 4. 依赖关系与实施顺序

1. 配置项扩展与校验
2. OCR 结构化输出与关键词定位
3. UI 点击能力补强
4. 场景注册表与模板异常流程
5. OCR 异常流程与通用异常流程
6. 频道专属异常流程
7. 黑屏期保护与模板优先策略
8. 通用报错策略与证据留存统一化
9. 日志与可追溯性增强
10. 测试与验收用例设计

## 5. 验收清单（设计阶段）

- 已完成任务拆分，覆盖模板优先与 OCR 降级策略。
- 黑屏期保护与两轮全量尝试逻辑明确。
- 配置项、模块改动与依赖关系清晰可执行。

