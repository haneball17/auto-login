# 窗口离屏导致自动流程失败的改进方案

## 1. 背景与问题

在当前自动登录流程中，若游戏窗口部分处于屏幕外（离屏），会出现以下现象：

- 模板匹配持续失败（频道、角色、进入游戏界面无法识别）。
- 点击动作命中错误位置或无效点击。
- 流程最终超时并触发重试或失败留证。

该问题会显著降低流程稳定性，尤其在多显示器、分辨率切换、窗口被拖拽后更容易复现。

## 2. 根因分析（基于当前实现）

### 2.1 窗口矩形未做可见性校验

- `src/ui_ops.py:get_window_rect` 直接返回 `GetWindowRect` 结果。
- 当前缺少“窗口与虚拟桌面可见交集”的运行时校验。

影响：窗口部分离屏时，后续截图和点击仍按完整窗口坐标处理，导致偏移。

## 2.2 ROI 裁剪默认窗口图完整可见

- `src/ui_ops.py:_capture_with_roi`
- `src/ui_ops.py:_crop_region`

影响：窗口图像实际被系统裁剪后，ROI 仍按原始相对坐标切片，匹配区域错误。

## 2.3 点击坐标未校验是否可点击

- `src/runner.py:_click_roi_button` 通过 `window_left/top + roi_center` 直接点击。
- `src/ui_ops.py:_send_input_click` 使用主屏宽高映射绝对坐标。

影响：在负坐标、多屏扩展或离屏坐标下，点击精度下降甚至失效。

## 2.4 多窗口场景窗口选择策略不一致

- `src/process_ops.py:select_latest_active_window` 使用“前台优先 + 标题匹配”。
- `src/ui_ops.py:get_window_rect` 非前台时使用枚举结果第一个窗口。

影响：可能命中旧窗口或离屏窗口，扩大偏移问题。

## 3. 改进目标

- 在不改变主流程状态机的前提下，先阻断离屏导致的连锁失败。
- 提升多屏/负坐标场景的点击稳定性。
- 统一窗口选择策略，减少“选错窗口”概率。
- 保持与现有“失败留证、可回溯”机制兼容。

## 4. 改进方案（分级）

### 4.1 P0：窗口可见性前置校验（优先落地）

在每次关键截图/点击前执行窗口可见性检查：

- 计算窗口矩形与虚拟桌面可见区域交集比例。
- 当比例低于阈值（建议默认 `0.85`）时：
  - 立即触发失败留证（截图、窗口坐标、交集比例）。
  - 中止当前步骤并进入既有重试/失败分支。

建议新增配置（`flow`）：

- `window_visible_ratio_min: float = 0.85`
- `window_visibility_check_enabled: bool = true`

### 4.2 P1：点击层改为虚拟桌面坐标体系

改造 `SendInput` 坐标映射：

- 使用虚拟桌面边界（`SM_XVIRTUALSCREEN / SM_YVIRTUALSCREEN / SM_CXVIRTUALSCREEN / SM_CYVIRTUALSCREEN`）进行归一化。
- 点击前校验目标点是否在虚拟桌面边界内，超界直接告警并返回失败。

收益：解决多屏、负坐标下的点击偏移问题。

### 4.3 P1：统一窗口选择策略

将 `ui_ops.get_window_rect` 改为复用 `process_ops.select_latest_active_window` 的选窗原则：

- 前台匹配窗口优先。
- 否则选择最新激活的匹配窗口。

收益：避免截图与点击误用过期窗口。

### 4.4 P2（可选）：离屏自动自愈

可选配置化能力（默认关闭）：

- `window_auto_recover_enabled: bool = false`

当检测到离屏且开启自愈时，尝试将窗口拉回可视区域（`SetWindowPos`），再继续流程。

说明：该项与当前“窗口配置仅用于校验”的规范存在冲突，建议仅作为可选增强，不默认启用。

## 5. 涉及模块与改动点

- `src/ui_ops.py`
  - 增加窗口可见性计算与校验函数。
  - 改造 `SendInput` 虚拟桌面坐标映射。
  - 调整 `get_window_rect` 选窗逻辑。
- `src/runner.py`
  - 在 `_click_roi_button` 与关键模板匹配前加入窗口可见性校验调用。
- `src/config.py`
  - 增加窗口可见性检查相关配置字段及校验。
- `tests/`
  - 增加窗口可见性计算、边界点击、选窗策略一致性测试。

## 6. 验收标准

- 当窗口可见比例低于阈值时，流程能快速失败并产生证据，不再长时间空转重试。
- 多显示器负坐标场景下，点击命中率恢复稳定。
- 多同名窗口场景下，截图窗口与点击窗口一致。
- 原有正常可见场景下，流程成功率不下降。

## 7. 回滚策略

- 通过配置开关关闭窗口可见性检查（仅用于紧急回退）。
- 保持旧点击路径作为兜底（SendInput 失败后保留 pyautogui 回退）。
- 每项改动独立提交，出现问题可按提交粒度回滚。

## 8. 本次文档提交说明

本次提交为方案文档落地，不包含代码行为变更。后续将按 P0 -> P1 -> P2 顺序实施，优先保障稳定性与可回溯性。
